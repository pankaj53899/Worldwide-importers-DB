--MAKE SURE TO CREATE CUSTOMIZED TABLES IN YOUR DATABASE FIRST
--6 tables are [WideWorldImporters].[dbo].[Orders], [WideWorldImporters].[dbo].OrderLines, [WideWorldImporters].[dbo].Customers, [WideWorldImporters].[dbo].[Invoices], [WideWorldImporters].[dbo].[InvoiceLines], [WideWorldImporters].[dbo].[StockItems]
--Code to create tables is present in file named '1_create_your_custom_tables'
--Description of fields present in custom details are available in the file named '2_Column_description_for_the_custom_tables'

/*
1. Total Customers
How many customers are there in the database?
*/
select count(distinct CustomerID) from [WideWorldImporters].[dbo].Customers;
--663 customers

/*
2. Orders Count
How many total orders have been placed?
*/
select count(distinct OrderID) from [WideWorldImporters].[dbo].[Orders];
--73595 orders

/*
3. First and Last Order Dates
What is the date of the first and the most recent order in the system?
*/
select max(orderdate), min(orderdate) from [WideWorldImporters].[dbo].[Orders];
--latest order 2016-05-31
--oldest order 2013-01-01

/*
4. Customers from a City
List all customers having postal adress as "Ghoshville".
*/
select distinct customername from [WideWorldImporters].[dbo].Customers where postaladdressline2='Ghoshville';
--6 customers

/*
5. Products and Categories
Show all products along with their categories.
*/
select distinct stockitemname,stockgroupnames from [WideWorldImporters].[dbo].[StockItems];
--227 items

/*
6. Orders in Last 7 Days
How many orders were placed in the month of MAY 2016?
*/
select *  from [WideWorldImporters].[dbo].[Orders]
where OrderDate like '2016-05%';
--2047 orders

/*
7. Order Amounts per Customer
For each customer, show their name and total amount spent (from orders).
*/

with orderline_price as (select orderid, orderlineid,(unitprice*pickedquantity+unitprice*pickedquantity*taxrate*0.01) as orderline_amount 
from [WideWorldImporters].[dbo].OrderLines),
order_price as (select orderid, sum(orderline_amount) as order_amount from orderline_price group by orderid),
order_price_customer as (
select a.*, b.customerid, c.customername from order_price a
left join [WideWorldImporters].[dbo].[Orders] b on a.OrderID=b.OrderID
left join [WideWorldImporters].[dbo].Customers c on b.CustomerID=c.CustomerID)
select customername, sum(order_amount) as amount_spent from order_price_customer 
group by customername order by sum(order_amount) desc;

/*
8. Product Quantity Summary
For each product, show total quantity sold.
*/
select StockItemID,Description,sum(pickedquantity) as quantity_sold from [WideWorldImporters].[dbo].OrderLines
group by StockItemID,Description
order by sum(pickedquantity) desc;

/*
9. Completed vs Pending Orders
Count the number of orders that are not picked.
*/
select distinct orderid from [WideWorldImporters].[dbo].OrderLines 
where PickedQuantity=0;
--3085 orders 

/*
10. Most Expensive Product
Which product has the highest price?
*/
select top 1 StockItemID,StockItemName,UnitPrice from [WideWorldImporters].[dbo].[StockItems]
order by UnitPrice desc;
--Air cushion machine (Blue)

/*
11. Recent Signups
Show the names of customers who signed up in the last 30 days.
*/

select * from [WideWorldImporters].[dbo].Customers
where accountopeneddate between '2016-04-07' and '2016-05-07';

--another way
select * from [WideWorldImporters].[dbo].Customers
where accountopeneddate between (select dateadd(day,-30,max(accountopeneddate)) from [WideWorldImporters].[dbo].Customers) and 
(select max(accountopeneddate) from [WideWorldImporters].[dbo].Customers);

/*
12. Orders per Customer
How many orders has each customer placed? Show customer name and order count.
*/

with order_detail as (
select b.OrderID,b.customerid, c.customername 
from [WideWorldImporters].[dbo].[Orders] b
left join [WideWorldImporters].[dbo].Customers c on b.CustomerID=c.CustomerID)
select customername, count(orderid) as order_count from order_detail 
group by CustomerName
order by count(orderid) desc;

/*
13. Product Prices Over 1000
List all products priced above 1000.
*/
select * from [WideWorldImporters].[dbo].[StockItems]
where UnitPrice>1000;

/*
14. Unique Cities
From how many different cities do we have customers?
*/
select distinct PostalAddressLine2 from [WideWorldImporters].[dbo].Customers;
--452 address

/*
15. Orders with Total Above 5000
List all order IDs where the total_amount is more than 5000.
*/
with orderline_price as (select orderid, orderlineid,(unitprice*pickedquantity+unitprice*pickedquantity*taxrate*0.01) as orderline_amount 
from [WideWorldImporters].[dbo].OrderLines)
select orderid, sum(orderline_amount) as order_price from orderline_price
group by orderid
having sum(orderline_amount)>5000
order by sum(orderline_amount) desc;
--9906 orders

/*
16. Customer and Order Join
Show customer name, order_id, and order_date by joining customers and orders.
*/
select b.customername,a.orderid,a.orderdate from [WideWorldImporters].[dbo].[Orders] a
left join [WideWorldImporters].[dbo].Customers b on a.CustomerID=b.CustomerID;

/*
17. Product Category Count
How many products are there in each category?
*/
select StockGroupNames, count(stockitemid) as count_items from [WideWorldImporters].[dbo].[StockItems]
group by StockGroupNames
order by count(stockitemid) desc;

/*
18. Customer Email Format Check
Show all customers whose phone number is not in proper format. Ideally length should be 14 characters.
*/
select * from [WideWorldImporters].[dbo].Customers
where len(phonenumber)<>14;

/*
19. Orders with No Items
List any order IDs that have no matching rows in order_items.
*/
select a.* from [WideWorldImporters].[dbo].[Orders] a
where a.OrderID not in (select distinct OrderID from [WideWorldImporters].[dbo].OrderLines);

/*
20. Gray color Product
Find all items where the product description contains the color "Gray" 
*/
select * from [WideWorldImporters].[dbo].[StockItems]
where lower(StockItemName) like '%gray%';
